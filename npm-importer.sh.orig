#!/bin/bash
# vim: set ts=3 sw=3 autoindent smartindent:

# import our utilities
DIR="${BASH_SOURCE%/*}"
if [[ ! -d "$DIR" ]]; then DIR="$PWD"; fi
   . "$DIR/term_color.sh"


# These notes consider how to download a "release" of TOA
# for purposes of uploading it to codenest.


# ======================== [ function definitions ] ===========================

#---------------------------------

#---------------------------------
function usage() {

   green "Usage: $0 <npm package to import>"
   green "============================================================"
   grey  "  This script is intended to *import* an NPM package from   "
   grey  "  https://registry.npmjs.org without installing it or       "
   grey  "  requiring any elevated permissions, scan it for viruses,  "
   grey  "  and then upload it to our local npm-mpf registry (which   "
   grey  "  is *not* proxied and therefore a sanitary repository.     "
   grey  "                                                            "
   grey  "  Note:  this script will manipulate your .npmrc config-    "
   grey  "  ration during the importation process and then put it     "
   grey  "  back to the *expected* values.                            "
	grey  "                                                            "
	red   "  YOU ARE RESPONSIBLE TO VERIFY THE FOLLOWING:              "
   grey  "                                                            "
   grey  "      - you understand what this script is doing!           "
   grey  "      - you ensure that the virus scan is clean!            "
   grey  "      - you ensure that your NPM configuration is valid     "
   grey  "        after the completion of this script: your registry  "
   grey  "        must point to 'npm-mpf'!                            "
   grey  "                                                            "
   grey  "  -d | --debug                                              "
   grey  "       allow stdout to go to the terminal instead of        "
   grey  "       /dev/null                                            "
   grey  "                                                            "
   grey  "  -h : print the usage message and exit.                    "
   grey  "                                                            "
   green "============================================================"
   exit 1
}


#---------------------------------

#---------------------------------
function parse_args() {

   # get the simplified name of this script for getopt to use when reporting errors
   name="${0##*/}"

   # use getopt to do most of the work
   TEMP=`getopt -o hd --long debug -n $name -- "$@"`
   # catch any errors from getopt
   if [ $? -ne 0 ]; then
      usage
   fi

   eval set -- "$TEMP"

   while [ $# -gt 0 ]; do

      case "$1" in

         # process an option without a required argument
         -d | --debug ) output=/dev/stdout ; shift ;;

         # print the usage message
         -h) shift ; usage; break ;;

         # get rid of '--'; the optional params will be in '$@'
         --) shift ; break ;;

         # handle an error case (have I seen this, yet?)
         *) red "invalid option: -${OPTARG} " >&2 ;;
      esac
   done

   # if not cleanup, then get a module argument to add to the venv
   if [ $# -lt 1 ]; then
      red "no npm package specified for import!"
		usage
   else
      NPMPACKAGE=$1
      green  "Importing $NPMPACKAGE package..."
   fi
   yellow "-------------------------------------------------------------------"
}



#---------------------------------

#---------------------------------
function install_deps() {

	# $1 is expected to be the 'quarantine' directory (one up from package)
	# $2 is expected to be the package name (directory name of package)

	cd $1
	#tar zxvf $NPMPACKAGE/-/$NPMPACKAGE.tgz -C $NPMPACKAGE/-/
	for dep in `npm view --json $2 dependencies`
	do
		((indent+=3))
		install_deps $1 $dep
	done
	yellow "$(indent)installing $2"
	npm install -g $2

}


# ======================== [ script begins here ] ===========================

NPMPACKAGE=""
output=/dev/null
indent=0

parse_args $@

LOGFILE="${NPMPACKAGE}_clam.log"

#--------------------------------------
# ensure proper NPM configuration
#--------------------------------------
npm config set proxy "http://nexus.vsi-corp.com:8888"
npm config set https-proxy "http://nexus.vsi-corp.com:8888"
npm config set registry "http://nexus.vsi-corp.com:8888/repository/npm-mpf/"
npm config set strict-ssl false
 
#--------------------------------------
# ensure local installation
#    - no escalated privileges
#--------------------------------------
cd ${HOME}
mkdir -p ~/.global-modules
npm config set prefix "~/.global-modules"
export PATH=~/.global-modules/bin:$PATH

# make sure that our npm-package-downloader tool is installed
which npmDownload > ${output} 2>&1
if [ $? -ne 0 ]; then
	green "installing npm-package-downloader from $(npm config get registry)."
	npm install -g npm-package-downloader >& ${output}
	grey  "\tdone."
fi


#
# quarantine directory
#
if [ -d ~/npm-quarantine ]; then
	cyan "This script will erase and recreate ~/npm-quarantine to use as a"
	cyan "  sanitary sandbox. Do you confirm that it is OK to delete this"
	cyan "  directory? [Y/N]: "

	while true; do
		cmode $fg_magenta
		read -p "Do you confirm that it is OK? [Y/N] :: " yn

		# verify response
		case $yn in
			[Y]* ) break;;
			[N]* ) red "   exiting." ; exit 1 ;;
            * ) grey "  Please answer Yes or No";;
		esac
	done
	cmode $reset

	rm -rf ~/npm-quarantine
fi

# recreate the clean sandbox
mkdir -p ~/npm-quarantine
 
# temporarily open up our registry to hit npm
npm config delete proxy
npm config delete https-proxy
 
# download the package with dependencies.
npmDownload -p "${NPMPACKAGE}" --dependencies -o ~/npm-quarantine
 
# set our registry correctly again
npm config set proxy http://nexus.vsi-corp.com:8888/
npm config set https-proxy http://nexus.vsi-corp.com:8888/
 
# scan the downloaded software
cd ~/npm-quarantine
clamscan -ri ~/npm-quarantine &> "${LOGFILE}"

# get the value of "Infected lines" 
MALWARE=$(tail "${LOGFILE}" | grep Infected |cut -d" " -f3) 

# if the value is not equal to zero, abort!!
if [ "$MALWARE" -ne "0" ];then 
	red "Malware has been detected while scanning ${NPMPACKAGE}!"
	red "$(indent 3)Aborting the import."
	yellow "$(indent 5)$NPMPACKAGE will be kept in ~/npm-quarantine."
	yellow "$(indent 5)Notify an SA immediately to report malware detection."
	exit 1
fi 

# find dependencies
install_deps ~/npm-quarantine $NPMPACKAGE

yellow "aborting early to see what's happening"

exit 0


yellow "Publishing $NPMPACKAGE and its dependencies to 'npm-mpf' nexus repo"
# add credentials to MPF hosted npm registry
npm adduser --registry=http://nexus.vsi-corp.com:8888/repository/npm-mpf/  # this requires your Crowd credentials
 
for package in `find . -name "package.json" | xargs -I{} dirname {}`
for package in `find . -name "*.tgz" | xargs -I{} dirname {}`

# publish to npm-mpf repo
npm publish --access public
green  "$(indent)done."
 

yellow "Publishing all dependencies of $NPMPACKAGE to 'npm-mpf' nexus repo"




